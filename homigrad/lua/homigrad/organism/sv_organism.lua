--[[
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%#######%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%#*++===========+**#%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%*++====================*#%%%%%%%%%%%%%%%
%%%%%%%%%%%%#*+=====================----=*%%%%%%%%%%%%%
%%%%%%%%%%#*======================--------=*%%%%%%%%%%%
%%%%%%%%%*+=====================------------+#%%%%%%%%%
%%%%%%%#+======================---------------*%%%%%%%%
%%%%%%#+=========*%#############**=------------*%%%%%%%
%%%%%#+=========#%%%%%%#####%%%%%%%#+-----------+%%%%%%
%%%%#+=========+%%%%%%%%%%#***#%%%%%%*---------:-*%%%%%
%%%%+==========#%%%%%%%%%%%%%#**+****#*------::::-#%%%%
%%%*==========+%%%*+#%%%%%%%%%%%%##**#%+----::::::=%%%%
%%%+==========#%%%#+=+#%%%%%%%%%%%%%%%%#--:::::::::*%%%
%%*=======+*##%%%%%#=--=+*#%%%%%%%%%%%%%*::::::::::=%%%         ─███──███───██─████────████─────█───█───██─████─████─███
%%+====+##%%%%%%%%%%#+-----==+**%%%%%%%%#-::::::::::#%%         ─█─█──█────█─█─█──█────█──██────█───█──█─█─█──█─█──█─█──
%%+===#%%%%%%*#%%%%%%%#*==-==+*#%%%%%%%%%+::::::::::#%%         ─█─█──███─█──█─█──█────████─────█─█─█─█──█─████─█──█─███
%#===#%%%%%%#==*#%%%%%%%%%%%%%%%%%%%%%%%%*::::::::::*%%         █████─█───█──█─█──█────█──██────█─█─█─█──█──█─█─█──█─█──
%#===%%%%%%%*==-=+*#%%%%%%%%%%%%%%%%%%%%%#-:::::::::+%%         █───█─███─█──█─████────████─────█████─█──█──█─█─█──█─███
%#===#%%%%%%%#=-----=+*###%%%%%%%%%%%%##+##*-:::::::+%%
%%===*%%%%%%%%%*+=-----=---==+++++++=--:-#%%#+::::::*%%
%%+===#%%%%%%%%%%%#*+=--------:::::::::-*%%%%%#-::::#%%
%%*====*%%%%%%%%%%%%%%%#**+===-----==+*#%%%%%%%#-::-%%%
%%#=====+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#:.*%%%
%%%*=-----+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=-%%%%
%%%%=-------+*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=*%%%%
%%%%#=---------+*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*+%%%%%
%%%%%*------------=*#%%%%%%%%%%%%%%%%%%%%%%%%%*-=%%%%%%
%%%%%%*---------------==+**####%%%%%%%%###*+=:.=%%%%%%%
%%%%%%%#=---------::::::::::::::------:::....:+%%%%%%%%
%%%%%%%%#+-------::::::::::::::::::::::.....-#%%%%%%%%%
%%%%%%%%%%#=---:::::::::::::::::::::::....:+%%%%%%%%%%%
%%%%%%%%%%%%*=::::::::::::::::::::::....:+%%%%%%%%%%%%%
%%%%%%%%%%%%%%#+-::::::::::::::::::..:=*%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%#+=-:::::::::::::-+*%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%#**+++++*#%%%%%%%%%%%%%%%%%%%%%%%

          ██
         █▒▒█
         █▒▒█
         █▒▒█
      ██▒█▒▒█
    ██▒▒██▒▒█
  ██▒▒█▒█████            ╔╗╔╗╔═╔╗╔╗
 █▒▒█▒▒█▒▒▒▒▒█           ║║║║╠╗║║║║
█▒█▒▒█▒▒███▒▒▒█          ╩╩╚╝╚╝╠╝╚╝
 █▒█▒▒█▒▒█▒█▒▒█
 █▒█▒▒███▒▒▒▒█
  █▒██▒▒▒▒▒▒█
   █▒▒▒▒▒▒▒█
    █▒▒▒▒▒▒█  
   ██████████

                                                                                                
                                                                                                
                                                                                                
                                    .:...     .+***********                                     
                             =-:..            .+***************:                                
                  -..:-===:..                 .+********************                            
               =:.     ..                     .+************************#***+                   
             =:                      ..::----==       ***************************               
           =.                   ..:-=+                      ***********************             
                               .--=+                          #*********************+           
           -.                   .-=+                          #**********************           
           =-.                    .-=====--::::+****         ***********************            
          +=.                       ...       .+***********************************#            
          =.                                  .+************************************#           
         -.                                   .+*************************************#          
        =.        .:.                       ..:+**************************************          
       =.        :---:.                   .:-=+    #************************#**********         
      +:        .=+++=-.                   -=+      **********************    **********        
      -.       .=+    +=:                  .=+      ********************#      *********        
     +:        -+     +-.                   -+     ********************#       #*********       
     =.       .=      +.                    :+     *********************        *********       
    +-        -+     +-        .:...         =    ***********************       #********+      
    +:       .=+     +:        :======-::... :    *******     #**********       #*********      
    +.       .=+     +.        -=+       +++                   #*********       #*********      
    +:       .=+     +.        -=+                              *********       #*********      
    +:       .=+     +:        -==++++==--::.:   #**           #*********       #*********      
    +:        -+     +:        .:::....     .=    **********###**********       #*********      
     -        :+      =.                    :+    **********************#       *********=      
     +.       .=+     =:                   .=+     *********************        *********       
     +-        :=    +=-.                  :+      ********************#       *********+       
      =.        -=++==:.                  .=+      #********************      #*********        
       -.       .:---.                    :-=+     #*********************#   #*********#        
       +-        ...                      ..::-****************************#***********         
        +:                                    .+**************************************          
         +:                                   .+*************************************           
         +=:.                       .         .+************************************            
          =-.                     :-==-::...  .+********  #************************             
         +:                    .:-=+         =               **********************             
         -.                   .--=+                          ##*********************            
          +:                   ..:-=+                       #***********************            
            =.                     ..::--==++           **************************              
              =.     ...                   ...:+********************************                
                 : :-===-:.                   .+**********************##****-                   
                           =-:.               .+******************                              
                               =--:..         .+*************                                   
                                     ==---.    =****=                                           
                                                                                                
                                                                                                
Не изменяйся, будь самим собой.
Ты можешь быть собой, пока живешь.
Когда же смерть разрушит образ твой,
Пусть будет кто-то на тебя похож.
Тебе природой красота дана
На очень краткий срок, и потому
Пускай по праву перейдет она
К наследнику прямому твоему.
В заботливых руках прекрасный дом
Не дрогнет перед натиском зимы,
И никогда не воцарится в нем
Дыханье смерти, холода и тьмы.
О, пусть, когда настанет твой конец,
Звучат слова: "Был у меня отец!"

--------------------------------------------------------

На прототипе Orignal Homigrad 2023

учавствовали:
checha, остальные лица ЗАСЕКРЕЧЕНЫ

]]--

local PMeta = FindMetaTable("Player")
local EMeta = FindMetaTable("Entity")

util.AddNetworkString("tracePosesSend")
util.AddNetworkString("hg_bloodimpact")
util.AddNetworkString("PlusHitrays")
util.AddNetworkString("AddHole")
util.AddNetworkString("organism_send")

ListWBone = {
    "ValveBiped.forward",
    "ValveBiped.Bip01_Head1",
    "ValveBiped.Bip01_L_UpperArm",
    "ValveBiped.Bip01_L_Forearm",
    "ValveBiped.Bip01_L_Hand",
    "ValveBiped.Bip01_R_UpperArm",
    "ValveBiped.Bip01_R_Forearm",
    "ValveBiped.Bip01_R_Hand",
    "ValveBiped.Bip01_Pelvis",
    "ValveBiped.Bip01_Spine",
    "ValveBiped.Bip01_Spine1",
    "ValveBiped.Bip01_Spine2",
    "ValveBiped.Bip01_L_Thigh",
    "ValveBiped.Bip01_L_Calf",
    "ValveBiped.Bip01_L_Foot",
    "ValveBiped.Bip01_R_Thigh",
    "ValveBiped.Bip01_R_Calf",
    "ValveBiped.Bip01_R_Foot"
}

Arteries = {
	["arteria"] = { var = "Neck", bone = "ValveBiped.Bip01_Neck1"},
	["larmartery"] = { var = "LArm", bone = "ValveBiped.Bip01_L_Forearm"},
	["rarmartery"] = { var = "RArm", bone = "ValveBiped.Bip01_R_Forearm"},
	["llegartery"] = { var = "LLeg", bone = "ValveBiped.Bip01_L_Thigh"},
	["rlegartery"] = { var = "RLeg", bone = "ValveBiped.Bip01_R_Thigh"},
    ["spineartery"] = { var = "SpineArtery", bone = "ValveBiped.Bip01_Spine2"},
}

ListArteriesTourniquet = {
	"arteria",
	"larmartery",
	"rarmartery",
	"llegartery",
	"rlegartery",
}

ListArteries = {
	"arteria",
	"larmartery",
	"rarmartery",
	"llegartery",
	"rlegartery",
    "spineartery",
}

-- господи пожалуйста спаси сохрани эта молитва перед кодингом этого говна что бы все работало, пожалуйста спаси сохрани
-- все боги св части помоги и наведи меня на верный путь...

function EMeta:XRaySendData(tracePoses, hitBoxs, dmg, bone, matpos, matang, trace, inBody)
    net.Start("tracePosesSend")
        net.WriteEntity(self)
        net.WriteTable(hitBoxs)
        net.WriteFloat(dmg)
        net.WriteVector(matpos)
        net.WriteAngle(matang)
        net.WriteTable(trace)
        net.WriteBool(inBody)
    net.Broadcast()
end

function EMeta:XRayCookData(force, bTable, dmginfo, hBone, trace)
    local boxs, pos, sphere = hg.organism.ShootMatrix(self, bTable)
    local endPos, hitBoxs, inputHole, outputHole, tracePoses, dir, distance = hg.organism.Trace(dmginfo:GetDamagePosition(), force, boxs, pos, sphere, bTable, nil, hg.organism.Trace_Bullet, bTable)
    local inBody = true
    if #outputHole > 0 then inBody = false end
    local mat = self:GetBoneMatrix(hBone)
    local matrix_position, matrix_angle = mat:GetTranslation(), mat:GetAngles()
    self:XRaySendData(tracePoses, hitBoxs, dmginfo:GetDamage() / 2, hBone, matrix_position, matrix_angle, trace, inBody)
end

function PMeta:ResetOrganism()
    self.DataDelay = CurTime()
    self.OtrubData = {
        Message = false,
        Delay = 0,
    }
    self.PulseData = {
        Message = false,
        Delay = 0,
    }
	self.Organism = {
        leaching = CurTime(),
        owner = self,
        naloxone = 0,
        heartstop = false,
        pulse = 60,
        internalBleed = 0,
        alive = true,
		Hit = {},
        unbalance = 0,
		Blood = 5000,
		anesthetics = 0,
        o2 = {
            30,
            30,
        },
        stamina = {
			100,
			100,
		},
		pain = 0,
		rarm = 1,
		larm = 1,
		rleg = 1,
		lleg = 1,
		immobilization = 0,
		Otrub = false,
		adrenaline = 0,
		disorientation = 0,
		WoundsDelay = {
            ["ValveBiped.Bip01_Head1"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.forward"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_UpperArm"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Forearm"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Hand"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_UpperArm"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Forearm"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Hand"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_Pelvis"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_Spine"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_Spine1"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_Spine2"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Thigh"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Calf"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Foot"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Thigh"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Calf"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Foot"] = { bleed = 0, delbleed = 0 },
        },
		Wounds = {
            ["ValveBiped.Bip01_Head1"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.forward"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_UpperArm"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Forearm"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Hand"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_UpperArm"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Forearm"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Hand"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_Pelvis"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_Spine"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_Spine1"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_Spine2"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Thigh"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Calf"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_L_Foot"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Thigh"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Calf"] = { bleed = 0, delbleed = 0 },
            ["ValveBiped.Bip01_R_Foot"] = { bleed = 0, delbleed = 0 },
        },
		Artery = {Delay = 0,},
	}
end

local function GetHitBone(target, hitPos)
    if not target:IsPlayer() and not target:IsRagdoll() then return nil end
    
    local boneCount = target:GetBoneCount()
    if boneCount <= 0 then return nil end
    
    local hitBone = nil
    local minDist = math.huge
    
    for bone = 0, boneCount - 1 do
        local bonePos, boneAng = target:GetBonePosition(bone)
        
        if bonePos then
            local dist = hitPos:DistToSqr(bonePos)
            
            if dist < minDist then
                minDist = dist
                hitBone = bone
            end
        end
    end
    
    return target:GetBoneName(hitBone), hitBone
end

function EMeta:RegRegisterXRayHit(damaginfo)
    local wep = damaginfo:GetAttacker():GetActiveWeapon()
    if damaginfo:IsDamageType(DMG_BULLET+DMG_BUCKSHOT+DMG_SNIPER) and wep.GetTrace then
        local _, hBoneID = GetHitBone(self,damaginfo:GetDamagePosition())
        local pen = damaginfo:GetDamageForce()
        pen:Mul(0.009)
        self:XRayCookData(pen, hg.organism.GetHitBoxOrgans(self:GetModel(), self), damaginfo, hBoneID, wep:GetTrace())
    end
end

local OrganHitMessages = {
    ["liver"] = "You can taste something in your mouth.",
    ["intestines"] = "You can taste something in your mouth.",
    ["trachea"] = "You feel difficulty breathing, you have something stuck below your throat.",
    ["lungsL"] = "You feel the air filling in your lungs, it becomes difficult for you to breathe and you have shortness of breath.",
    ["lungsR"] = "You feel the air filling in your lungs, it becomes difficult for you to breathe and you have shortness of breath.",
}

local ForInternalBleeding = {
    "intestines",
    "liver",
    "stomach",
    "chest"
}

function EMeta:KernelInternalBleeding(hits)
    for index, organ in ipairs(ForInternalBleeding) do
        if table.HasValue(hits, organ) then
            self.Organism.internalBleed = self.Organism.internalBleed + 10
        end
    end
end

function EMeta:MuchBleeding()
    local bleed = 0
    for _, bone in ipairs(ListWBone) do
        bleed = bleed + self.Organism.Wounds[bone].bleed
    end
    return bleed
end

function EMeta:HealBleeding(much)
    for _, bone in ipairs(ListWBone) do
        if self.Organism.Wounds[bone].bleed > 0 then
            self.Organism.Wounds[bone].bleed = self.Organism.Wounds[bone].bleed - (much or 1)
        end
    end
end

-- ебать я конечно просто гений эти функции просто нахуй ебаный нахуй нахуй
local function GetOrganByBox(pos, ang, min, max, organs)
    for bone, organList in pairs(organs) do
        for _, organData in ipairs(organList) do
            if organData[4] == ang and organData[3] == min and organData[6] == max then
                return organData[1]
            end
        end
    end
    return nil
end

local function HitOrgan(boneTable, hitPos, force, ply)
    local ishit = {}
    local boxs, pos, sphere = hg.organism.ShootMatrix(ply, boneTable)
    local endPos, hitBoxs, inputHole, outputHole = hg.organism.Trace(hitPos, force, boxs, pos, sphere, boneTable, nil, hg.organism.Trace_Bullet, boneTable)
    for i = 1, #boxs do
        for ind_organ, val in pairs(hitBoxs) do
            if not ind_organ then continue end
            local box = boxs[ind_organ]
            if not box[6] then continue end
            local organ = box[6] and boneTable[box[6]][box[7]]
            table.insert(ishit, organ[1])
            --[[
            net.Start("PlusHitrays")
                net.WriteVector(box[1])
                net.WriteAngle(ply:GetAngles())
                net.WriteVector(box[3])
                net.WriteVector(box[4])
                net.WriteColor(Color(math.random(0,255),math.random(0,255),math.random(0,255),255))
            net.Broadcast()
            --]]
        end
    end
    return ishit
end

function bparticle(pos, vel, bool)
    net.Start("blood particle")
    net.WriteVector(pos)
    net.WriteVector(vel)
    net.WriteBool(bool or false)
    net.Broadcast()
end

function BloodImpact(pos, vel, bool)
    net.Start("hg_bloodimpact")
    net.WriteVector(pos)
    net.WriteVector(vel)
    net.Broadcast()
end

function EMeta:IsOrganHit(hit)
    return table.HasValue(self.Organism.Hit, hit)
end

function PMeta:NotifyAboutOrgan(organ)
    if OrganHitMessages[organ] then
        self:Notify(OrganHitMessages[organ])
    end
end

hook.Add("EntityTakeDamage", "fmsdkgdfg", function(target,dmginfo)
    local r_ent = hg.RagdollOwner(target)
    if target:IsPlayer() or target:IsRagdoll() then
        if not r_ent.Organism then return end
        local addvelocity = 0
        if target:IsRagdoll() then
            print(target:GetVelocity():Length())
        end
        r_ent.Organism.pain = r_ent.Organism.pain + (dmginfo:GetDamage()/3) + addvelocity
        r_ent.Organism.pulse = r_ent.Organism.pulse + (((dmginfo:GetDamage()/3) + addvelocity)/2)
        if dmginfo:IsDamageType(DMG_CRUSH+DMG_FALL) then return end
        local hitboxes = hg.organism.GetHitBoxOrgans(target:GetModel(), target)
        local hitbone, hId = GetHitBone(target,dmginfo:GetDamagePosition())
        -- some shit from hg omfg....
        local penetration = dmginfo:GetDamageForce()
        if dmginfo:IsDamageType(DMG_BULLET + DMG_SLASH) then
            penetration:Mul(0.009)
        else
            penetration:Mul(0.004)
        end
        if target:IsRagdoll() and hg.RagdollOwner(target):IsPlayer() then
            if hg.RagdollOwner(target):Alive() then
                local dmg = dmginfo
                dmg:SetDamage( dmginfo:GetDamage()*2.5 )
                hg.RagdollOwner(target):TakeDamageInfo( dmg )
            end
        end
        local t_vel = target:GetAttachment(target:LookupAttachment("eyes")).Ang
        local dmg = (dmginfo:GetDamage()/3)
        local vel = t_vel:Forward()*(dmg) + t_vel:Right()*math.random(-2,2)
        bparticle(dmginfo:GetDamagePosition(), vel, false)
        local hits = HitOrgan(hitboxes, dmginfo:GetDamagePosition(), penetration, target)
        if dmginfo:IsDamageType(DMG_BULLET+DMG_BUCKSHOT+DMG_SNIPER) then
            for _, organ in ipairs(hits) do
                if not table.HasValue(r_ent.Organism.Hit, organ) then
                    table.insert(r_ent.Organism.Hit, organ)
                    if r_ent:IsPlayer() then r_ent:NotifyAboutOrgan(organ) end
                end
            end
        end
        r_ent:KernelInternalBleeding(hits)
        for _, bone in ipairs(ListWBone) do
            if hitbone == bone and r_ent != dmginfo:GetAttacker() then
                r_ent.Organism.Wounds[hitbone].delbleed = CurTime()
                r_ent.Organism.Wounds[hitbone].bleed = r_ent.Organism.Wounds[hitbone].bleed + math.random(5,10)
                r_ent.Organism.Blood = r_ent.Organism.Blood - 10
            end
        end
        if r_ent:Alive() and r_ent:Health() <= 0 then
            r_ent:Kill()
        end
    end
end)

hook.Add("ScalePlayerDamage", "dmaksdkmasf", function(target, hitgroup, dmginfo)
    if target:IsPlayer() and target.Organism then
        if hitgroup == HITGROUP_HEAD then
            target.Organism.unbalance = target.Organism.unbalance + 10
        end
        if hitgroup == HITGROUP_CHEST or hitgroup == HITGROUP_STOMACH then
            target.Organism.unbalance = target.Organism.unbalance + 1.5
        end
        if hitgroup == HITGROUP_LEFTLEG or hitgroup == HITGROUP_RIGHTLEG then
            target.Organism.unbalance = target.Organism.unbalance + 3
        end
    end
end)

local function Artery(ent, target, bone)
    target.Organism.Artery.Delay = CurTime() + 0.089
    target.Organism.Blood = target.Organism.Blood - math.random(5,10)
    if not bone or not ent:LookupBone(bone) then return end
    local neck = ent:GetBonePosition(ent:LookupBone(bone))
    local nt_vel = ent:GetAttachment(ent:LookupAttachment("eyes")).Ang
    if bone == "ValveBiped.Bip01_Spine2" then
        nt_vel = -ent:GetAttachment(ent:LookupAttachment("eyes")).Ang
    end
    local nvel = nt_vel:Forward()*math.random(60,100) + nt_vel:Right()*math.random(-30,30)
    bparticle(neck, nvel, true)
end

function EMeta:Leaching(var, much, func)
    if self.Organism[var] > 0 then
        self.Organism[var] = self.Organism[var] - much
        if self.Organism[var] < 0 then
            self.Organism[var] = 0
        end
        if func != nil and func then
            func()
        end
    end
end

local PulseMessage = {
    [true] = "You feel a strong heartbeat, your hands are shaking and your heart is pounding in your chest very fast.",
    [false] = "You feel calm and somewhat weak in your arms, your head aches and itches, and a migraine begins.",
}

function EMeta:CoreOrganism()
    local ent = self
    if not self.Organism then return end
    if self:IsPlayer() then
        ent = hg.GetCurrentCharacter(self)
    end
    if not IsValid(ent) then return end
    if self.Organism.Blood <= 0 then if self:Alive() then self:Kill() end return end

    if self.Organism.Artery.Delay < CurTime() then
        for _, type_artery in ipairs(ListArteries) do
            if self:IsOrganHit(type_artery) then
                Artery(ent, self, Arteries[type_artery].bone)
            end
        end
    end

    for _, bone in ipairs(ListWBone) do
        if self.Organism.Wounds[bone].bleed >= 1 and self.Organism.Wounds[bone].delbleed < CurTime() then
            self.Organism.Wounds[bone].delbleed = CurTime() + 0.6
            self.Organism.Wounds[bone].bleed = math.Clamp(self.Organism.Wounds[bone].bleed - 1, 0, 999999)
            self.Organism.Blood = self.Organism.Blood - math.random(5,10)
            local pos = ent:GetBonePosition(ent:LookupBone(bone))
            local t_vel = ent:GetAttachment(ent:LookupAttachment("eyes")).Ang
            local vel = t_vel:Forward()*30 + t_vel:Right()*math.random(-30,30)
            bparticle(pos, vel)
        end
    end

    if self:IsOrganHit("brain") and self:Alive() then
        self:Kill()
    end

    if self:IsOrganHit("heart") then
        self.Organism.heartstop = true
    end

    if self.Organism.pulse < 20 then
        self.Organism.heartstop = true
    end

    self.Organism.o2[1] = math.Clamp(self.Organism.o2[1], 0, 30)
    self.Organism.o2[2] = math.Clamp(self.Organism.o2[2], 0, 30)

    if self.Organism.o2[1] < 2.5 and self.Organism.o2[2] < 2.5 and self:Alive() then
        self:Kill()
    end
    
    if self:IsPlayer() then
        if self.Organism.unbalance >= 5 and not self.fake and self:Alive() then
            self:Notify("You feel unsteady on your feet and fall.")
            Faking(self)
        end

        if self.Organism.disorientation >= 30 and not self.fake and self:Alive() then
            self:Notify("You're disoriented, your head is buzzing, and you're falling.")
            Faking(self)
        end

        local highpulse = (self.Organism.pulse < 45 and false) or (self.Organism.pulse > 90 and true) or nil
        if not self.PulseData.Message and self:Alive() and highpulse != nil then
            self:Notify(PulseMessage[highpulse])
            self.PulseData.Delay = CurTime() + 30
            self.PulseData.Message = true
        end

        if not self.Organism.Otrub and (self.Organism.pulse < 40 or self.Organism.pulse > 160 or self.Organism.Blood < 3000 or self:MuchBleeding() >= 35 or self.Organism.pain >= 130) then
            if not self.OtrubData.Message then
                self.Organism.disorientation = self.Organism.disorientation + 20
                self:Notify("You feel dizzy, you want to sleep, apparently you are passing out.")
                self.OtrubData.Delay = CurTime() + 30
                self.OtrubData.Message = true
            end
        end

        if self.PulseData.Message and self.PulseData.Delay < CurTime() then
            self.PulseData.Message = false
        end

        if self.OtrubData.Message and self.OtrubData.Delay < CurTime() then
            self.OtrubData.Message = false
        end
    end

    if self.Organism.heartstop or not self.Organism.alive or self.Organism.pulse < 25 or self.Organism.Blood < 2500 or self:MuchBleeding() >= 50 or self.Organism.pain >= 200 then
        self.Organism.Otrub = true
    else
        self.Organism.Otrub = false
    end

    if self.Organism.leaching < CurTime() then
        self.Organism.leaching = self.Organism.leaching + 2
        if self.Organism.heartstop then self:Leaching("pulse", 2, nil) end
        if self:IsOrganHit("lungsL") then self.Organism.o2[1] = self.Organism.o2[1] - 0.1 end
        if self:IsOrganHit("lungsR") then self.Organism.o2[2] = self.Organism.o2[2] - 0.1 end
        if self.tourniquets and table.HasValue(self.tourniquets, "arteria") then self.Organism.o2[1] = self.Organism.o2[1] - 0.5 end
        
        if not self.Organism.alive then self.Organism.heartstop = true end

        if self.Organism.pulse > 90 then
            self:Leaching("pulse", 2, nil)
        end
        if self.Organism.pulse < 25 and not self.Organism.heartstop then
            self.Organism.pulse = self.Organism.pulse + 2
        end
        self:Leaching("internalBleed", 1, function()
            self:Leaching("Blood", 50, nil)
        end)
        self:Leaching("immobilization", 2.5, nil)
        self:Leaching("unbalance", 2.5, nil)
        self:Leaching("pain", 10, nil)
        self:Leaching("naloxone", 1, nil)
        self:Leaching("adrenaline", 1, function()
            self.Organism.pulse = self.Organism.pulse + 3
        end)
        self:Leaching("disorientation", 5, nil)
        self:Leaching("anesthetics", 0.2, function()
            self:Leaching("pain", 4, nil)
        end)
    end
end

hook.Add("Move", "maksmkgdfg", function(ply,mv)
    if ply:Alive() and ply.DataDelay < CurTime() then
        ply.DataDelay = ply.DataDelay + 0.5
        local neworg = table.Copy(ply.Organism)
        neworg.Hit = {}
        neworg.Wounds = {}
        neworg.WoundsDelay = {}
        neworg.bleed = ply:MuchBleeding()
        net.Start("organism_send")
            net.WriteTable(neworg)
        net.Send(ply)
    end
end)

hook.Add("Think", "ORGANISM_CORE_GLSPLGFH", function()
    for _, ply in ipairs(player.GetAll()) do
        if ply:Alive() then
            ply:CoreOrganism()
        end
    end
end)

hook.Add("Think","dlasdlaspd", function()
    for i,ent in ipairs(RagdollsChechaSSexy) do
        if IsValid(ent) then
            if not ent:GetNWInt("Temp", 1) then
                ent:SetNWBool("Temp", 1)
            end
            if ent.Organism then
                if not ent.Organism.alive then
                    ent:SetNWBool("Temp", Lerp(0.0009, ent:GetNWInt("Temp", 1), 0))
                end
            end
            ent:CoreOrganism()
        else
            table.RemoveByValue(RagdollsChechaSSexy, ent)
        end
    end
end)

-- TRASHBIN

local function _HitOrgan(boneTable, hitPos, force, ply)
    local ishit = ishit or {}
    for bone, organs in pairs(boneTable) do
        --PrintTable(organs)
        local org = hg.organism.ShootMatrix(ply, boneTable)
        for i,box in pairs(org) do
            local hit = util.IntersectRayWithOBB(hitPos, force, box[1], box[2], box[3], box[4])
            if hit != nil then
                local organColor = box[7] and organs[box[7]] and organs[box[7]][6] or Color(255, 255, 255)
                if organs[box[7]] then
                    table.insert(ishit, organs[box[7]][1])
                    net.Start("PlusHitrays")
                        net.WriteVector(box[1])
                        net.WriteAngle(box[2])
                        net.WriteVector(box[3])
                        net.WriteVector(box[4])
                        net.WriteColor(organColor)
                    net.Broadcast()
                end
            end
        end
    end
    return ishit
end