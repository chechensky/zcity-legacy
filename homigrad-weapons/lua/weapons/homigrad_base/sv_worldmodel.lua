-- "addons\\homigrad-weapons\\lua\\weapons\\homigrad_base\\sv_worldmodel.lua"
-- Scripthooked by ???

--[[
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%#######%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%#*++===========+**#%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%*++====================*#%%%%%%%%%%%%%%%
%%%%%%%%%%%%#*+=====================----=*%%%%%%%%%%%%%
%%%%%%%%%%#*======================--------=*%%%%%%%%%%%
%%%%%%%%%*+=====================------------+#%%%%%%%%%
%%%%%%%#+======================---------------*%%%%%%%%
%%%%%%#+=========*%#############**=------------*%%%%%%%
%%%%%#+=========#%%%%%%#####%%%%%%%#+-----------+%%%%%%
%%%%#+=========+%%%%%%%%%%#***#%%%%%%*---------:-*%%%%%
%%%%+==========#%%%%%%%%%%%%%#**+****#*------::::-#%%%%
%%%*==========+%%%*+#%%%%%%%%%%%%##**#%+----::::::=%%%%
%%%+==========#%%%#+=+#%%%%%%%%%%%%%%%%#--:::::::::*%%%
%%*=======+*##%%%%%#=--=+*#%%%%%%%%%%%%%*::::::::::=%%%         ─███──███───██─████────████─────█───█───██─████─████─███
%%+====+##%%%%%%%%%%#+-----==+**%%%%%%%%#-::::::::::#%%         ─█─█──█────█─█─█──█────█──██────█───█──█─█─█──█─█──█─█──
%%+===#%%%%%%*#%%%%%%%#*==-==+*#%%%%%%%%%+::::::::::#%%         ─█─█──███─█──█─█──█────████─────█─█─█─█──█─████─█──█─███
%#===#%%%%%%#==*#%%%%%%%%%%%%%%%%%%%%%%%%*::::::::::*%%         █████─█───█──█─█──█────█──██────█─█─█─█──█──█─█─█──█─█──
%#===%%%%%%%*==-=+*#%%%%%%%%%%%%%%%%%%%%%#-:::::::::+%%         █───█─███─█──█─████────████─────█████─█──█──█─█─█──█─███
%#===#%%%%%%%#=-----=+*###%%%%%%%%%%%%##+##*-:::::::+%%
%%===*%%%%%%%%%*+=-----=---==+++++++=--:-#%%#+::::::*%%
%%+===#%%%%%%%%%%%#*+=--------:::::::::-*%%%%%#-::::#%%
%%*====*%%%%%%%%%%%%%%%#**+===-----==+*#%%%%%%%#-::-%%%
%%#=====+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#:.*%%%
%%%*=-----+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=-%%%%
%%%%=-------+*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=*%%%%
%%%%#=---------+*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*+%%%%%
%%%%%*------------=*#%%%%%%%%%%%%%%%%%%%%%%%%%*-=%%%%%%
%%%%%%*---------------==+**####%%%%%%%%###*+=:.=%%%%%%%
%%%%%%%#=---------::::::::::::::------:::....:+%%%%%%%%
%%%%%%%%#+-------::::::::::::::::::::::.....-#%%%%%%%%%
%%%%%%%%%%#=---:::::::::::::::::::::::....:+%%%%%%%%%%%
%%%%%%%%%%%%*=::::::::::::::::::::::....:+%%%%%%%%%%%%%
%%%%%%%%%%%%%%#+-::::::::::::::::::..:=*%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%#+=-:::::::::::::-+*%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%#**+++++*#%%%%%%%%%%%%%%%%%%%%%%%

          ██
         █▒▒█
         █▒▒█
         █▒▒█
      ██▒█▒▒█
    ██▒▒██▒▒█
  ██▒▒█▒█████            ╔╗╔╗╔═╔╗╔╗
 █▒▒█▒▒█▒▒▒▒▒█           ║║║║╠╗║║║║
█▒█▒▒█▒▒███▒▒▒█          ╩╩╚╝╚╝╠╝╚╝
 █▒█▒▒█▒▒█▒█▒▒█
 █▒█▒▒███▒▒▒▒█
  █▒██▒▒▒▒▒▒█
   █▒▒▒▒▒▒▒█
    █▒▒▒▒▒▒█  
   ██████████

                                                                                                
                                                                                                
                                                                                                
                                    .:...     .+***********                                     
                             =-:..            .+***************:                                
                  -..:-===:..                 .+********************                            
               =:.     ..                     .+************************#***+                   
             =:                      ..::----==       ***************************               
           =.                   ..:-=+                      ***********************             
                               .--=+                          #*********************+           
           -.                   .-=+                          #**********************           
           =-.                    .-=====--::::+****         ***********************            
          +=.                       ...       .+***********************************#            
          =.                                  .+************************************#           
         -.                                   .+*************************************#          
        =.        .:.                       ..:+**************************************          
       =.        :---:.                   .:-=+    #************************#**********         
      +:        .=+++=-.                   -=+      **********************    **********        
      -.       .=+    +=:                  .=+      ********************#      *********        
     +:        -+     +-.                   -+     ********************#       #*********       
     =.       .=      +.                    :+     *********************        *********       
    +-        -+     +-        .:...         =    ***********************       #********+      
    +:       .=+     +:        :======-::... :    *******     #**********       #*********      
    +.       .=+     +.        -=+       +++                   #*********       #*********      
    +:       .=+     +.        -=+                              *********       #*********      
    +:       .=+     +:        -==++++==--::.:   #**           #*********       #*********      
    +:        -+     +:        .:::....     .=    **********###**********       #*********      
     -        :+      =.                    :+    **********************#       *********=      
     +.       .=+     =:                   .=+     *********************        *********       
     +-        :=    +=-.                  :+      ********************#       *********+       
      =.        -=++==:.                  .=+      #********************      #*********        
       -.       .:---.                    :-=+     #*********************#   #*********#        
       +-        ...                      ..::-****************************#***********         
        +:                                    .+**************************************          
         +:                                   .+*************************************           
         +=:.                       .         .+************************************            
          =-.                     :-==-::...  .+********  #************************             
         +:                    .:-=+         =               **********************             
         -.                   .--=+                          ##*********************            
          +:                   ..:-=+                       #***********************            
            =.                     ..::--==++           **************************              
              =.     ...                   ...:+********************************                
                 : :-===-:.                   .+**********************##****-                   
                           =-:.               .+******************                              
                               =--:..         .+*************                                   
                                     ==---.    =****=                                           
                                                                                                
                                                                                                
Не изменяйся, будь самим собой.
Ты можешь быть собой, пока живешь.
Когда же смерть разрушит образ твой,
Пусть будет кто-то на тебя похож.
Тебе природой красота дана
На очень краткий срок, и потому
Пускай по праву перейдет она
К наследнику прямому твоему.
В заботливых руках прекрасный дом
Не дрогнет перед натиском зимы,
И никогда не воцарится в нем
Дыханье смерти, холода и тьмы.
О, пусть, когда настанет твой конец,
Звучат слова: "Был у меня отец!"

--------------------------------------------------------

Функции были восстановлены по прототипу Harrison Homigrad

учавствовали:
prizmar1n, wdaourselves and checha

комментарий от checha: я блять в жизни поверить не мог что так можно было сделать, я думал это будет дичайший рассинхрон на SetPos и SetAngles
комментарий от wdaourselves: мне нравятся пушки
комментарий от prizmar1n: круто, но хочу больше, буду двигаться

]]--
local angZero = Angle(0, 0, 0)
local math_max, math_Clamp = math.max, math.Clamp

local angZero, vecZero = Angle(0, 0, 0), Vector(0, 0, 0)
local angPosture3 = Angle(-30, 10, -20)
local angPosture4 = Angle(30, 20, 0)
local angSuicide = Angle(-30, 120, 0)
local angReload = Angle(-30, 20, 0)
local funcNil = function() end

hg.postureFuncWorldModel = {
	[3] = function(self,ply)
		self.weaponAng:Add(angPosture3)
	end,
	[5] = function(self,ply)
		self.weaponAng[3] = self.weaponAng[3] - 20
	end,
	[6] = function(self,ply)
		self.weaponAng[3] = self.weaponAng[3] - 35
	end,
}

function SWEP:ChangeGunPosSV()
	local ply = self:GetOwner()

	if (self.frameTime or 0) > CurTime() then return end
	self.frameTime = CurTime() + 0.014

	local fakeRagdoll = IsValid(ply.FakeRagdoll)

	hook.Run("WeaponAnglesChange", self)
	self.weaponAng[1] = 0
	self.weaponAng[2] = 0
	self.weaponAng[3] = 0
	local animpos = self:GetAnimShoot2()
	animpos = animpos * (self.bipodPlacement and 0.25 or 1)
	animpos = animpos * ((self:IsLocal() or SERVER) and math.Clamp(self.SprayI / self:GetMaxClip1() * 2, not self.Primary.Automatic and 0.1 or 0.1, not self.Primary.Automatic and 0.1 or 1) or 1)
	self.weaponAng[1] = self.weaponAng[1] + animpos * -20 --* (self.holdtype == "revolver" and -20 or -20)
	if ply.viewingGun and ply.viewingGun > CurTime() then
		self.weaponAng:Add(Angle(math.sin(ply.viewingGun - CurTime()) * -5, math.sin(ply.viewingGun - CurTime()) * -5, math.cos(ply.viewingGun+1.5 - CurTime()) * 30))
		ply.viewingGun = not (self:KeyDown(IN_ATTACK2) or self:KeyDown(IN_ATTACK)) and ply.viewingGun or nil
	end

	if IsValid(ply.FakeRagdoll) then ply.lean = 0 end
	self.weaponAng[3] = self.weaponAng[3] + (ply.lean or 0) * 20
	if self.GetAnimPos_Draw and CLIENT then
		local animpos = math.Clamp(self:GetAnimPos_Draw(CurTime()),0,1)
		local sin = 1 - animpos
		if sin >= 0.5 then
			sin = 1 - sin
		else
			sin = sin * 1
		end
		sin = sin * 2
		sin = math.ease.InOutSine(sin)
		self.weaponAng[1] = self.weaponAng[1] - sin * 10
		self.weaponAng[2] = self.weaponAng[2] + sin * 20
		self.weaponAng[3] = self.weaponAng[3] + sin * -20
	end

	if not fakeRagdoll then

		local func = hg.postureFuncWorldModel[ply.posture] or funcNil
		func(self,ply)

		angPosture4[1] = 30 * (ply:EyeAngles()[1] > 60 and (90 - ply:EyeAngles()[1]) / 30 or 1)
		angPosture4[2] = 20 * (ply:EyeAngles()[1] > 60 and (90 - ply:EyeAngles()[1]) / 30 or 1)
		self.weaponAng:Add(ply.posture ~= 3 and self:IsSprinting() and angPosture4 or angZero)
		if ply.suiciding then self.weaponAng:Add(ply.suiciding and angSuicide or angZero) end
	end

	if ply.posture == 4 or ply.posture == 3 or ply.posture == 1 or ply.posture == 6 then ply.posture = (self:KeyDown(IN_ATTACK2) or (ply.posture ~= 1 and ply.posture ~= 6 and self:KeyDown(IN_ATTACK))) and 0 or ply.posture end
	
	local closeanim = self:CloseAnim(false)
	closeanim = closeanim or 0
	local trace = ply:GetEyeTrace()
	local way = trace.HitNormal:Dot(ply:EyeAngles():Up())

	if not self.bipodPlacement then
		self.weaponAng[1] = self.weaponAng[1] - 60 * (closeanim > 0.75 and (closeanim - 0.75) * (way > 0 and 1 or -1) or 0)
		self.weaponAng[3] = self.weaponAng[3] - math.abs(90 * (closeanim > 0.75 and (closeanim - 0.75) * (way > 0 and 1 or -1) or 0))
	end

	local brokenArm = ply.organism and ((ply.organism.larm or 0) + (ply.organism.rarm or 0)) or 0
	
	if not self.bipodPlacement then
		brokenArm = brokenArm + math.max((0.4 - self.Ergonomics),0) * (ply.posture == 1 and 5 or 30)
	end

	self.weaponAng[1] = self.weaponAng[1] + (brokenArm >= 1 and (math.sin(CurTime()) + 1) * brokenArm or 0)
	
	if CLIENT and self:IsLocal() then
		self.weaponAng[3] = self.weaponAng[3] + diffang2[2] * 2
		self.weaponAng[3] = self.weaponAng[3] - diffvec2:Dot(self:GetOwner():EyeAngles():Right()) * 5
	end

	self.weaponAng:Add((self.reload and self.reload - 0.25 > CurTime()) and not fakeRagdoll and angReload or angZero)
	self.weaponAngLerp = Lerp(0.3 * self.Ergonomics ^ 1, self.weaponAngLerp or Angle(0, 0, 0), self.weaponAng)
end

function SWEP:SVCreateWorldModel()
    local model = ents.Create("prop_dynamic")
    model:SetNoDraw(true)
    model:SetModel(self.WorldModel)
    model:SetMaterial("debug/debugleafviswireframe")
    model:Spawn()
    model:PhysicsDestroy()
    model:SetMoveType(MOVETYPE_NONE)
    model:SetNWBool("nophys", true)
    model:SetSolidFlags(FSOLID_NOT_SOLID)
    model:AddEFlags(EFL_NO_DISSOLVE)
    model:SetCollisionGroup(COLLISION_GROUP_WORLD)
    self:DeleteOnRemove(model)
    self.worldModel = model
    return model
end

function SWEP:WorldModel_Transform()
	local model, owner = self.worldModel, self:GetOwner()
	if not IsValid(model) then 
        model = self:SVCreateWorldModel() 
    else
	    if IsValid(owner) then
		    local ent = hg.GetCurrentCharacter(owner)
		    local RHand = ent:LookupBone("ValveBiped.Bip01_R_Hand")
		    local LHand = ent:LookupBone("ValveBiped.Bip01_L_Hand")

		    if not RHand or not LHand then return end

		    local matrixR = ent:GetBoneMatrix(RHand)
		    local matrixL = ent:GetBoneMatrix(LHand)
		
		    if not matrixR or not matrixL then return end

    		self:ChangeGunPosSV()
		
	    	local matrixRAngRot = matrixR:GetAngles()
    		matrixRAngRot:RotateAroundAxis(matrixRAngRot:Forward(),180)
		    local desiredAng = (owner.suiciding or (ent~=owner and not self:KeyDown(IN_ATTACK2))) and matrixRAngRot or (owner:EyeAngles() + (owner:InVehicle() and owner:GetVehicle():GetAngles() or Angle(0,0,0)))
	    	desiredAng:RotateAroundAxis(desiredAng:Forward(),180)
		    local desiredPos = matrixR:GetTranslation()

		    desiredPos,desiredAng = self:PosAngChanges(owner,desiredPos,desiredAng)

		    if ent == owner then
			    if not owner.suiciding then
				    desiredAng:Add(self.weaponAngLerp or angZero)
			    end
		    elseif ent~=owner and self:KeyDown(IN_ATTACK2) then
			    desiredAng:Add(self.weaponAngLerp or angZero)
			    if self.HoldType ~= "revolver" then
    				desiredPos:Add(matrixRAngRot:Up() * 2)
			    	desiredPos:Add(matrixRAngRot:Forward() * 1)
	    			desiredPos:Add(matrixRAngRot:Right() * 0)
		    	end
			    desiredAng[3] = matrixRAngRot[3] + 180
		    end

		    local newPos,newAng = LocalToWorld(self.WorldPos,self.WorldAng,desiredPos,desiredAng)
		    newAng:RotateAroundAxis(newAng:Forward(),180)
		
		    if self.bipodPlacement then
			    newPos = self.bipodPlacement
		    end

		    model:SetPos(newPos)
		    model:SetAngles(newAng)
        else
		    model:SetPos(self:GetPos())
		    model:SetAngles(self:GetAngles())
	    end
    end
end